<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lady Ember - Creative Audio Workstation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --accent-primary: #800020;
            --accent-light: #a0002a;
            --accent-muted: #f8d7da;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-muted: #adb5bd;
            --border-light: #dee2e6;
            --border-medium: #ced4da;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 20px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-light);
            padding: 20px 40px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .phone-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--text-secondary);
        }

        .phone-number {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 40px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-light);
        }

        .new-project-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
        }

        .new-project-btn:hover {
            background: var(--accent-light);
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .control-btn {
            background: white;
            border: 2px solid var(--border-medium);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .control-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .control-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .inbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .inbox-item {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .inbox-item:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .inbox-item.selected {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-muted);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .item-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .item-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .content-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .content-type.voice {
            background: var(--accent-muted);
            color: var(--accent-primary);
        }

        .content-type.text {
            background: #d1ecf1;
            color: #0c5460;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
            background: white;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .play-btn:hover, .play-btn.playing {
            background: var(--accent-primary);
            color: white;
        }

        .waveform {
            flex: 1;
            height: 60px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .waveform-bars {
            display: flex;
            align-items: end;
            height: 100%;
            padding: 10px;
            gap: 2px;
        }

        .waveform-bar {
            background: var(--accent-primary);
            min-height: 4px;
            width: 3px;
            border-radius: 2px;
            opacity: 0.7;
            transition: opacity 0.1s ease;
        }

        .speed-controls {
            display: flex;
            gap: 5px;
        }

        .speed-btn {
            padding: 4px 8px;
            border: 1px solid var(--border-medium);
            background: white;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .speed-btn:hover {
            background: var(--bg-secondary);
        }

        .speed-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .project-workspace {
            display: none;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
            margin-top: 30px;
            overflow: hidden;
        }

        .workspace-header {
            background: var(--bg-secondary);
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .workspace-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .workspace-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .timeline {
            min-height: 200px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            position: relative;
        }

        .timeline-ruler {
            height: 40px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .timeline-track {
            min-height: 80px;
            border-bottom: 1px solid var(--border-light);
            position: relative;
            padding: 10px 20px;
        }

        .audio-clip {
            background: var(--accent-primary);
            color: white;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            top: 15px;
            min-width: 100px;
            cursor: move;
            user-select: none;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .audio-clip:hover {
            background: var(--accent-light);
        }

        .metronome-panel {
            background: var(--bg-secondary);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bpm-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bpm-input {
            width: 80px;
            padding: 8px;
            border: 2px solid var(--border-medium);
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        .metronome-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--accent-primary);
            background: white;
            color: var(--accent-primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .metronome-btn.active {
            background: var(--accent-primary);
            color: white;
            animation: pulse 0.6s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .floating-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 15px;
        }

        .floating-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-hover);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .floating-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
        }

        /* Melodyne-style controls */
        .melodyne-controls {
            margin: 15px 0;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }

        .pitch-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .detected-key, .tempo-info {
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid var(--border-medium);
        }

        .transpose-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .transpose-slider {
            flex: 1;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            outline: none;
            appearance: none;
        }

        .transpose-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .transpose-value {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .pitch-track {
            height: 100px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .pitch-visualization {
            width: 100%;
            height: 100%;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .action-btn {
            background: white;
            border: 1px solid var(--border-medium);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .main-container {
                padding: 20px;
            }

            .toolbar {
                flex-direction: column;
                gap: 15px;
            }

            .inbox-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">üéµ Lady Ember Studio</div>
            <div class="phone-info">
                <span>üìû Call to Record:</span>
                <span class="phone-number">+1 (770) 758-2471</span>
                <span>üì± Text & Voice Messages Supported</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="toolbar">
            <button class="new-project-btn" onclick="toggleProjectMode()">
                ‚ú® New Project
            </button>

            <div class="controls">
                <button class="control-btn" onclick="importS3Zip()">üì¶ Import Archive</button>
                <button class="control-btn" onclick="refreshInbox()">üîÑ Refresh</button>
                <select class="control-btn" onchange="sortInbox(this.value)">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="name">By Name</option>
                </select>
            </div>
        </div>

        <div class="inbox-grid" id="inboxGrid">
            {% for item in inbox_items %}
            <div class="inbox-item" data-id="{{ item.id }}" data-type="{{ item.content_type }}" data-url="{{ item.s3_url }}">
                <div class="item-header">
                    <div>
                        <div class="item-title">{{ item.title }}</div>
                        <div class="item-meta">{{ item.sender_name }} ‚Ä¢ {{ item.date_folder }}</div>
                    </div>
                    <div class="content-type {{ item.content_type }}">{{ item.content_type }}</div>
                </div>

                {% if item.content_type == 'voice' and item.s3_url %}
                <div class="audio-controls">
                    <button class="play-btn" onclick="togglePlay('{{ item.id }}')">
                        <span id="play-icon-{{ item.id }}">‚ñ∂</span>
                    </button>
                    <div class="waveform" id="waveform-{{ item.id }}">
                        <div class="waveform-bars"></div>
                    </div>
                    <div class="speed-controls">
                        <button class="speed-btn" onclick="setSpeed('{{ item.id }}', 0.5)">0.5x</button>
                        <button class="speed-btn active" onclick="setSpeed('{{ item.id }}', 1)">1x</button>
                        <button class="speed-btn" onclick="setSpeed('{{ item.id }}', 1.5)">1.5x</button>
                        <button class="speed-btn" onclick="setSpeed('{{ item.id }}', 2)">2x</button>
                    </div>
                </div>

                <div class="melodyne-controls" id="melodyne-{{ item.id }}" style="display: none;">
                    <div class="pitch-info">
                        <span class="detected-key" id="key-{{ item.id }}">üéπ Key: Analyzing...</span>
                        <span class="tempo-info" id="tempo-{{ item.id }}">ü•Å BPM: Analyzing...</span>
                    </div>
                    <div class="transpose-controls">
                        <label>üéµ Transpose:</label>
                        <input type="range" min="-12" max="12" value="0" class="transpose-slider" id="transpose-{{ item.id }}" oninput="previewTranspose('{{ item.id }}', this.value)">
                        <span class="transpose-value" id="transpose-value-{{ item.id }}">0</span>
                        <button class="control-btn" onclick="applyTranspose('{{ item.id }}')">Apply</button>
                    </div>
                    <div class="pitch-track" id="pitch-track-{{ item.id }}">
                        <!-- Pitch visualization will be drawn here -->
                    </div>
                </div>

                <div class="item-actions">
                    <button class="action-btn" onclick="toggleMelodyne('{{ item.id }}')">üéº Analyze</button>
                    <button class="action-btn" onclick="duplicateItem('{{ item.id }}')">üìã Duplicate</button>
                    <button class="action-btn" onclick="deleteItem('{{ item.id }}')">üóëÔ∏è Delete</button>
                </div>
                <audio id="audio-{{ item.id }}" preload="none" onended="onAudioEnded('{{ item.id }}')">
                    <source src="{{ item.s3_url }}" type="audio/mpeg">
                </audio>
                {% endif %}

                <div class="item-content">{{ item.content }}</div>
            </div>
            {% endfor %}
        </div>

        <div class="project-workspace" id="projectWorkspace">
            <div class="workspace-header">
                <div class="workspace-title">üéº New Project Workspace</div>
                <div class="workspace-controls">
                    <button class="control-btn" onclick="addSilence()">‚ûï Add Silence</button>
                    <button class="control-btn" onclick="addVoiceCue()">üé§ Add Voice Cue</button>
                    <button class="control-btn" onclick="exportProject()">üíæ Export</button>
                    <button class="control-btn" onclick="closeProject()">‚úñ Close</button>
                </div>
            </div>

            <div class="timeline" id="timeline">
                <div class="timeline-ruler">
                    <span style="margin-right: 20px;">00:00</span>
                    <span style="margin-right: 20px;">00:30</span>
                    <span style="margin-right: 20px;">01:00</span>
                    <span>01:30</span>
                </div>
                <div class="timeline-track" id="timelineTrack" ondrop="dropAudioClip(event)" ondragover="allowDrop(event)">
                    <!-- Audio clips will be added here -->
                </div>
            </div>

            <div class="metronome-panel">
                <div class="bpm-control">
                    <span>üéµ BPM:</span>
                    <input type="number" class="bpm-input" id="bpmInput" value="120" min="60" max="200" onchange="updateBPM()">
                    <button class="metronome-btn" id="metronomeBtn" onclick="toggleMetronome()">‚ô™</button>
                </div>

                <div>
                    <button class="control-btn" onclick="playProject()">‚ñ∂ Play Project</button>
                    <button class="control-btn" onclick="pauseProject()">‚è∏ Pause</button>
                    <button class="control-btn" onclick="stopProject()">‚èπ Stop</button>
                </div>
            </div>
        </div>
    </div>

    <div class="floating-controls">
        <button class="floating-btn" onclick="scrollToTop()" title="Scroll to top">‚Üë</button>
    </div>

    <script>
        let selectedItems = new Set();
        let currentlyPlaying = null;
        let projectMode = false;
        let metronomeInterval = null;
        let metronomeActive = false;
        let timelineClips = [];

        // Auto-refresh inbox every 30 seconds
        setInterval(refreshInbox, 30000);

        function refreshInbox() {
            fetch('/api/inbox')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateInboxDisplay(data.items);
                    }
                })
                .catch(error => console.error('Error refreshing inbox:', error));
        }

        function updateInboxDisplay(items) {
            const grid = document.getElementById('inboxGrid');
            const currentItems = new Set([...grid.querySelectorAll('.inbox-item')].map(el => el.dataset.id));

            items.forEach(item => {
                if (!currentItems.has(String(item.id))) {
                    const element = createInboxItemElement(item);
                    grid.insertBefore(element, grid.firstChild);
                }
            });
        }

        function createInboxItemElement(item) {
            const div = document.createElement('div');
            div.className = 'inbox-item';
            div.dataset.id = item.id;
            div.dataset.type = item.content_type;
            div.dataset.url = item.s3_url || '';

            div.innerHTML = `
                <div class="item-header">
                    <div>
                        <div class="item-title">${item.title}</div>
                        <div class="item-meta">${item.sender_name} ‚Ä¢ ${item.date_folder}</div>
                    </div>
                    <div class="content-type ${item.content_type}">${item.content_type}</div>
                </div>
                ${item.content_type === 'voice' && item.s3_url ? `
                <div class="audio-controls">
                    <button class="play-btn" onclick="togglePlay('${item.id}')">
                        <span id="play-icon-${item.id}">‚ñ∂</span>
                    </button>
                    <div class="waveform" id="waveform-${item.id}">
                        <div class="waveform-bars"></div>
                    </div>
                    <div class="speed-controls">
                        <button class="speed-btn" onclick="setSpeed('${item.id}', 0.5)">0.5x</button>
                        <button class="speed-btn active" onclick="setSpeed('${item.id}', 1)">1x</button>
                        <button class="speed-btn" onclick="setSpeed('${item.id}', 1.5)">1.5x</button>
                        <button class="speed-btn" onclick="setSpeed('${item.id}', 2)">2x</button>
                    </div>
                </div>
                <audio id="audio-${item.id}" preload="none" onended="onAudioEnded('${item.id}')">
                    <source src="${item.s3_url}" type="audio/mpeg">
                </audio>` : ''}
                <div class="item-content">${item.content}</div>
            `;

            return div;
        }

        function toggleProjectMode() {
            projectMode = !projectMode;
            const workspace = document.getElementById('projectWorkspace');
            const btn = document.querySelector('.new-project-btn');

            if (projectMode) {
                workspace.style.display = 'block';
                btn.innerHTML = 'üéµ Back to Inbox';
                enableItemSelection();
            } else {
                workspace.style.display = 'none';
                btn.innerHTML = '‚ú® New Project';
                disableItemSelection();
                selectedItems.clear();
            }
        }

        function enableItemSelection() {
            document.querySelectorAll('.inbox-item').forEach(item => {
                item.addEventListener('click', toggleItemSelection);
                item.style.cursor = 'pointer';
            });
        }

        function disableItemSelection() {
            document.querySelectorAll('.inbox-item').forEach(item => {
                item.removeEventListener('click', toggleItemSelection);
                item.classList.remove('selected');
                item.style.cursor = 'default';
            });
        }

        function toggleItemSelection(event) {
            if (!projectMode) return;

            const item = event.currentTarget;
            const itemId = item.dataset.id;

            if (selectedItems.has(itemId)) {
                selectedItems.delete(itemId);
                item.classList.remove('selected');
            } else {
                selectedItems.add(itemId);
                item.classList.add('selected');
            }
        }

        function togglePlay(itemId) {
            const audio = document.getElementById(`audio-${itemId}`);
            const playIcon = document.getElementById(`play-icon-${itemId}`);
            const playBtn = playIcon.parentElement;

            if (currentlyPlaying && currentlyPlaying !== itemId) {
                // Stop currently playing audio
                const currentAudio = document.getElementById(`audio-${currentlyPlaying}`);
                const currentIcon = document.getElementById(`play-icon-${currentlyPlaying}`);
                const currentBtn = currentIcon.parentElement;

                currentAudio.pause();
                currentIcon.innerHTML = '‚ñ∂';
                currentBtn.classList.remove('playing');
            }

            if (audio.paused) {
                audio.play();
                playIcon.innerHTML = '‚è∏';
                playBtn.classList.add('playing');
                currentlyPlaying = itemId;
                generateWaveform(itemId);
            } else {
                audio.pause();
                playIcon.innerHTML = '‚ñ∂';
                playBtn.classList.remove('playing');
                currentlyPlaying = null;
            }
        }

        function setSpeed(itemId, speed) {
            const audio = document.getElementById(`audio-${itemId}`);
            audio.playbackRate = speed;

            // Update active speed button
            const container = audio.parentElement;
            container.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
            container.querySelector(`[onclick*="${speed}"]`).classList.add('active');
        }

        function onAudioEnded(itemId) {
            const playIcon = document.getElementById(`play-icon-${itemId}`);
            const playBtn = playIcon.parentElement;

            playIcon.innerHTML = '‚ñ∂';
            playBtn.classList.remove('playing');
            currentlyPlaying = null;
        }

        function generateWaveform(itemId) {
            const waveformBars = document.querySelector(`#waveform-${itemId} .waveform-bars`);
            waveformBars.innerHTML = '';

            // Generate random waveform bars for visual effect
            const barCount = 50;
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'waveform-bar';
                bar.style.height = Math.random() * 40 + 10 + 'px';
                waveformBars.appendChild(bar);
            }
        }

        function updateBPM() {
            const bpm = document.getElementById('bpmInput').value;
            if (metronomeActive) {
                stopMetronome();
                startMetronome(bpm);
            }
        }

        function toggleMetronome() {
            const btn = document.getElementById('metronomeBtn');

            if (metronomeActive) {
                stopMetronome();
                btn.classList.remove('active');
                metronomeActive = false;
            } else {
                const bpm = document.getElementById('bpmInput').value;
                startMetronome(bpm);
                btn.classList.add('active');
                metronomeActive = true;
            }
        }

        function startMetronome(bpm) {
            const interval = 60000 / bpm;
            metronomeInterval = setInterval(() => {
                // Play metronome sound (using Web Audio API or simple beep)
                playMetronomeClick();
            }, interval);
        }

        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }
        }

        function playMetronomeClick() {
            // Simple audio context click
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'square';

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function addSilence() {
            const duration = prompt('Silence duration in seconds:', '2');
            if (duration) {
                addToTimeline('silence', `üîá Silence (${duration}s)`, duration);
            }
        }

        function addVoiceCue() {
            const text = prompt('Voice cue text:', 'Chorus goes here...');
            if (text) {
                addToTimeline('cue', `üé§ ${text}`, '3');
            }
        }

        function addToTimeline(type, label, duration) {
            const clip = {
                id: Date.now(),
                type: type,
                label: label,
                duration: parseFloat(duration),
                position: timelineClips.length * 120
            };

            timelineClips.push(clip);
            renderTimelineClip(clip);
        }

        function renderTimelineClip(clip) {
            const track = document.getElementById('timelineTrack');
            const element = document.createElement('div');
            element.className = 'audio-clip';
            element.style.left = clip.position + 'px';
            element.style.width = (clip.duration * 40) + 'px';
            element.innerHTML = clip.label;
            element.draggable = true;
            element.dataset.clipId = clip.id;

            element.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', clip.id);
            });

            track.appendChild(element);
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function dropAudioClip(event) {
            event.preventDefault();
            // Handle dropping selected items into timeline
            if (selectedItems.size > 0) {
                selectedItems.forEach(itemId => {
                    const item = document.querySelector(`[data-id="${itemId}"]`);
                    if (item && item.dataset.type === 'voice') {
                        const title = item.querySelector('.item-title').textContent;
                        addToTimeline('audio', title, '30'); // Estimate 30s duration
                    }
                });
            }
        }

        function importS3Zip() {
            const zipKey = prompt('Enter S3 zip file name:', 'your-archive.zip');
            if (zipKey) {
                fetch('/import/s3-zip', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({zip_key: zipKey})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úÖ Successfully imported ${data.imported_count} audio files!`);
                        refreshInbox();
                    } else {
                        alert(`‚ùå Import failed: ${data.error}`);
                    }
                })
                .catch(error => {
                    alert(`‚ùå Import error: ${error.message}`);
                });
            }
        }

        function sortInbox(sortBy) {
            const grid = document.getElementById('inboxGrid');
            const items = Array.from(grid.children);

            items.sort((a, b) => {
                switch(sortBy) {
                    case 'newest':
                        return parseInt(b.dataset.id) - parseInt(a.dataset.id);
                    case 'oldest':
                        return parseInt(a.dataset.id) - parseInt(b.dataset.id);
                    case 'name':
                        const nameA = a.querySelector('.item-title').textContent;
                        const nameB = b.querySelector('.item-title').textContent;
                        return nameA.localeCompare(nameB);
                    default:
                        return 0;
                }
            });

            items.forEach(item => grid.appendChild(item));
        }

        function closeProject() {
            toggleProjectMode();
        }

        function playProject() {
            alert('üéµ Project playback coming soon!');
        }

        function pauseProject() {
            alert('‚è∏ Project pause coming soon!');
        }

        function stopProject() {
            alert('‚èπ Project stop coming soon!');
        }

        function exportProject() {
            alert('üíæ Project export coming soon!');
        }

        function scrollToTop() {
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        // Melodyne-style functions
        function toggleMelodyne(itemId) {
            const melodyne = document.getElementById(`melodyne-${itemId}`);
            const btn = event.target;

            if (melodyne.style.display === 'none') {
                melodyne.style.display = 'block';
                btn.innerHTML = 'üéº Hide Analysis';
                analyzeAudio(itemId);
            } else {
                melodyne.style.display = 'none';
                btn.innerHTML = 'üéº Analyze';
            }
        }

        function analyzeAudio(itemId) {
            const item = document.querySelector(`[data-id="${itemId}"]`);
            const audioUrl = item.dataset.url;

            if (!audioUrl) return;

            // Show loading state
            document.getElementById(`key-${itemId}`).innerHTML = 'üéπ Key: Analyzing...';
            document.getElementById(`tempo-${itemId}`).innerHTML = 'ü•Å BPM: Analyzing...';

            fetch('/api/analyze-audio', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    audio_url: audioUrl,
                    analysis_type: 'full'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const results = data.analysis_results;

                    // Update key detection
                    if (results.key_detection) {
                        document.getElementById(`key-${itemId}`).innerHTML =
                            `üéπ Key: ${results.key_detection.detected_key} (${Math.round(results.key_detection.confidence * 100)}%)`;
                    }

                    // Update tempo
                    if (results.spectral_analysis) {
                        document.getElementById(`tempo-${itemId}`).innerHTML =
                            `ü•Å BPM: ${Math.round(results.spectral_analysis.tempo)}`;
                    }

                    // Draw pitch visualization
                    if (results.pitch_track) {
                        drawPitchTrack(itemId, results.pitch_track);
                    }
                } else {
                    document.getElementById(`key-${itemId}`).innerHTML = 'üéπ Key: Analysis failed';
                    document.getElementById(`tempo-${itemId}`).innerHTML = 'ü•Å BPM: Analysis failed';
                }
            })
            .catch(error => {
                console.error('Analysis error:', error);
                document.getElementById(`key-${itemId}`).innerHTML = 'üéπ Key: Error';
                document.getElementById(`tempo-${itemId}`).innerHTML = 'ü•Å BPM: Error';
            });
        }

        function drawPitchTrack(itemId, pitchTrack) {
            const container = document.getElementById(`pitch-track-${itemId}`);
            container.innerHTML = '<canvas class="pitch-visualization" id="pitch-canvas-' + itemId + '"></canvas>';

            const canvas = document.getElementById(`pitch-canvas-${itemId}`);
            const ctx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            if (pitchTrack.length === 0) return;

            // Find pitch range
            const freqs = pitchTrack.map(p => p.frequency).filter(f => f > 0);
            if (freqs.length === 0) return;

            const minFreq = Math.min(...freqs);
            const maxFreq = Math.max(...freqs);
            const freqRange = maxFreq - minFreq;

            // Draw pitch curve
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
            ctx.lineWidth = 2;
            ctx.beginPath();

            pitchTrack.forEach((point, index) => {
                if (point.frequency > 0) {
                    const x = (point.time / pitchTrack[pitchTrack.length - 1].time) * canvas.width;
                    const y = canvas.height - ((point.frequency - minFreq) / freqRange) * canvas.height;

                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
            });

            ctx.stroke();

            // Draw note names at key points
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
            ctx.font = '10px Inter, sans-serif';
            ctx.textAlign = 'center';

            for (let i = 0; i < pitchTrack.length; i += Math.floor(pitchTrack.length / 10)) {
                const point = pitchTrack[i];
                if (point.frequency > 0) {
                    const x = (point.time / pitchTrack[pitchTrack.length - 1].time) * canvas.width;
                    const y = canvas.height - ((point.frequency - minFreq) / freqRange) * canvas.height;
                    ctx.fillText(point.note_name, x, Math.max(y - 5, 15));
                }
            }
        }

        function previewTranspose(itemId, semitones) {
            document.getElementById(`transpose-value-${itemId}`).innerHTML =
                semitones > 0 ? `+${semitones}` : semitones;
        }

        function applyTranspose(itemId) {
            const item = document.querySelector(`[data-id="${itemId}"]`);
            const audioUrl = item.dataset.url;
            const semitones = document.getElementById(`transpose-${itemId}`).value;

            if (!audioUrl || semitones == 0) return;

            if (!confirm(`Transpose by ${semitones > 0 ? '+' : ''}${semitones} semitones? This will create a new version.`)) {
                return;
            }

            const btn = event.target;
            btn.innerHTML = 'Processing...';
            btn.disabled = true;

            fetch('/api/transpose-audio', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    audio_url: audioUrl,
                    semitones: parseFloat(semitones)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ Transposed version created! Refreshing inbox...`);
                    refreshInbox();
                } else {
                    alert(`‚ùå Transpose failed: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`‚ùå Transpose error: ${error.message}`);
            })
            .finally(() => {
                btn.innerHTML = 'Apply';
                btn.disabled = false;
            });
        }

        function duplicateItem(itemId) {
            alert('üìã Duplicate feature coming soon!');
        }

        function deleteItem(itemId) {
            if (confirm('üóëÔ∏è Are you sure you want to delete this item?')) {
                alert('Delete feature coming soon!');
            }
        }

        // Initialize waveforms for all audio items on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.inbox-item[data-type="voice"]').forEach(item => {
                generateWaveform(item.dataset.id);
            });
        });
    </script>
</body>
</html>