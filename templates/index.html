<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lady Ember - Creative Audio Workstation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --accent-primary: #800020;
            --accent-light: #a0002a;
            --accent-muted: #f8d7da;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-muted: #adb5bd;
            --border-light: #dee2e6;
            --border-medium: #ced4da;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 20px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-light);
            padding: 20px 40px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .phone-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--text-secondary);
        }

        .phone-number {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 40px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-light);
        }

        .new-project-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
        }

        .new-project-btn:hover {
            background: var(--accent-light);
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .control-btn {
            background: white;
            border: 2px solid var(--border-medium);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .control-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .control-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .inbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .inbox-item {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .inbox-item:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .inbox-item.selected {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-muted);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .item-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .item-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .content-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .content-type.voice {
            background: var(--accent-muted);
            color: var(--accent-primary);
        }

        .content-type.text {
            background: #d1ecf1;
            color: #0c5460;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
            background: white;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .play-btn:hover, .play-btn.playing {
            background: var(--accent-primary);
            color: white;
        }

        .waveform {
            flex: 1;
            height: 60px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .waveform-bars {
            display: flex;
            align-items: end;
            height: 100%;
            padding: 10px;
            gap: 2px;
        }

        .waveform-bar {
            background: var(--accent-primary);
            min-height: 4px;
            width: 3px;
            border-radius: 2px;
            opacity: 0.7;
            transition: opacity 0.1s ease;
        }

        .speed-controls {
            display: flex;
            gap: 5px;
        }

        .speed-btn {
            padding: 4px 8px;
            border: 1px solid var(--border-medium);
            background: white;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .speed-btn:hover {
            background: var(--bg-secondary);
        }

        .speed-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .project-workspace {
            display: none;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
            margin-top: 30px;
            overflow: hidden;
        }

        .workspace-header {
            background: var(--bg-secondary);
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .workspace-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .workspace-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .timeline {
            min-height: 200px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            position: relative;
        }

        .timeline-ruler {
            height: 40px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .timeline-track {
            min-height: 80px;
            border-bottom: 1px solid var(--border-light);
            position: relative;
            padding: 10px 20px;
        }

        .audio-clip {
            background: var(--accent-primary);
            color: white;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            top: 15px;
            min-width: 100px;
            cursor: move;
            user-select: none;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .audio-clip:hover {
            background: var(--accent-light);
        }

        .metronome-panel {
            background: var(--bg-secondary);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bpm-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bpm-input {
            width: 80px;
            padding: 8px;
            border: 2px solid var(--border-medium);
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        .metronome-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--accent-primary);
            background: white;
            color: var(--accent-primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .metronome-btn.active {
            background: var(--accent-primary);
            color: white;
            animation: pulse 0.6s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .floating-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 15px;
        }

        .floating-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-hover);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .floating-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
        }

        /* Melodyne-style controls */
        .melodyne-controls {
            margin: 15px 0;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }

        .pitch-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .detected-key, .tempo-info {
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid var(--border-medium);
        }

        .transpose-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .transpose-slider {
            flex: 1;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            outline: none;
            appearance: none;
        }

        .transpose-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .transpose-value {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .pitch-track {
            height: 100px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .pitch-visualization {
            width: 100%;
            height: 100%;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .action-btn {
            background: white;
            border: 1px solid var(--border-medium);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* Three-tab system styles */
        .main-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid var(--border-light);
        }

        .tab-btn {
            background: white;
            border: 1px solid var(--border-medium);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--text-secondary);
            flex: 1;
            text-align: center;
        }

        .tab-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .tab-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Project tab specific styles */
        .projects-container {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .project-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
        }

        .project-item:hover {
            box-shadow: var(--shadow);
            transform: translateY(-1px);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .project-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .project-actions {
            display: flex;
            gap: 10px;
        }

        .project-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Phrases tab specific styles */
        .phrases-container {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .phrase-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
        }

        .phrase-item:hover {
            box-shadow: var(--shadow);
            transform: translateY(-1px);
        }

        .editable-title {
            background: transparent;
            border: 1px solid transparent;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: text;
            transition: all 0.2s ease;
        }

        .editable-title:hover, .editable-title:focus {
            background: white;
            border-color: var(--accent-primary);
            outline: none;
        }

        .save-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .editable-title:focus + .save-btn, .save-btn:hover {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .main-container {
                padding: 20px;
            }

            .toolbar {
                flex-direction: column;
                gap: 15px;
            }

            .inbox-grid {
                grid-template-columns: 1fr;
            }

            .main-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">🎵 Lady Ember Studio</div>
            <div class="phone-info">
                <span>📞 Call to Record:</span>
                <span class="phone-number">+1 (770) 758-2471</span>
                <span>📱 Text & Voice Messages Supported</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="main-tabs">
            <button class="tab-btn active" onclick="showTab('inbox')">📥 Inbox</button>
            <button class="tab-btn" onclick="showTab('projects')">🎼 Projects</button>
            <button class="tab-btn" onclick="showTab('phrases')">📝 Phrases</button>
        </div>

        <!-- Inbox Tab -->
        <div id="inbox-tab" class="tab-content active">
            <div class="toolbar">
                <button class="new-project-btn" onclick="createNewProject()" id="newProjectBtn">
                    ✨ New Project
                </button>

                <div class="controls">
                    <button class="control-btn" onclick="importS3Zip()">📦 Import Archive</button>
                    <select class="control-btn" onchange="sortContent(this.value)">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="name">By Name</option>
                    </select>
                    <button class="control-btn" onclick="bulkDelete()">🗑️ Bulk Delete</button>
                </div>
            </div>

            <div class="inbox-grid" id="inboxGrid">
                {% for item in inbox_items %}
                <div class="inbox-item" data-id="{{ item.id }}" data-type="{{ item.content_type }}" data-url="{{ item.s3_url }}">
                    <div class="item-header">
                        <div>
                            <input type="text" class="editable-title" value="{{ item.title }}" data-id="{{ item.id }}" onblur="updateTitle('{{ item.id }}', this.value)" />
                            <button class="save-btn" onclick="updateTitle('{{ item.id }}', this.previousElementSibling.value)">💾</button>
                            <div class="item-meta">{{ item.sender_name }} • {{ item.date_folder }}</div>
                        </div>
                        <div class="content-type {{ item.content_type }}">{{ item.content_type }}</div>
                    </div>

                    {% if item.content_type == 'voice' and item.s3_url %}
                    <div class="audio-controls">
                        <button class="play-btn" onclick="togglePlay('{{ item.id }}')">
                            <span id="play-icon-{{ item.id }}">▶</span>
                        </button>
                        <div class="waveform" id="waveform-{{ item.id }}">
                            <div class="waveform-bars"></div>
                        </div>
                        <div class="speed-controls">
                            <button class="speed-btn" onclick="setSpeed('{{ item.id }}', 0.5)">0.5x</button>
                            <button class="speed-btn active" onclick="setSpeed('{{ item.id }}', 1)">1x</button>
                            <button class="speed-btn" onclick="setSpeed('{{ item.id }}', 1.5)">1.5x</button>
                            <button class="speed-btn" onclick="setSpeed('{{ item.id }}', 2)">2x</button>
                        </div>
                    </div>

                    <div class="melodyne-controls" id="melodyne-{{ item.id }}" style="display: none;">
                        <div class="pitch-info">
                            <span class="detected-key" id="key-{{ item.id }}">🎹 Key: Analyzing...</span>
                            <span class="tempo-info" id="tempo-{{ item.id }}">🥁 BPM: Analyzing...</span>
                        </div>
                        <div class="transpose-controls">
                            <label>🎵 Transpose:</label>
                            <input type="range" min="-12" max="12" value="0" class="transpose-slider" id="transpose-{{ item.id }}" oninput="previewTranspose('{{ item.id }}', this.value)">
                            <span class="transpose-value" id="transpose-value-{{ item.id }}">0</span>
                            <button class="control-btn" onclick="applyTranspose('{{ item.id }}')">Apply</button>
                        </div>
                        <div class="pitch-track" id="pitch-track-{{ item.id }}">
                            <!-- Pitch visualization will be drawn here -->
                        </div>
                    </div>

                    <div class="item-actions">
                        <button class="action-btn" onclick="toggleMelodyne('{{ item.id }}')">🎼 Analyze</button>
                        <button class="action-btn" onclick="sendToProject('{{ item.id }}')">📁 To Project</button>
                        <button class="action-btn" onclick="sendToPhrases('{{ item.id }}')">📝 To Phrases</button>
                        <button class="action-btn" onclick="deleteItem('{{ item.id }}')">🗑️ Delete</button>
                    </div>
                    <audio id="audio-{{ item.id }}" preload="none" onended="onAudioEnded('{{ item.id }}')">
                        <source src="{{ item.s3_url }}" type="audio/mpeg">
                    </audio>
                    {% endif %}

                    <div class="item-content">{{ item.content }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects-tab" class="tab-content">
            <div class="toolbar">
                <button class="new-project-btn" onclick="createNewProject()">
                    ✨ Create New Project
                </button>
                <div class="controls">
                    <select class="control-btn" onchange="filterProjects(this.value)">
                        <option value="all">All Projects</option>
                        <option value="recent">Recent</option>
                        <option value="favorites">Favorites</option>
                    </select>
                    <button class="control-btn" onclick="exportAllProjects()">💾 Export All</button>
                </div>
            </div>

            <div class="projects-container" id="projectsContainer">
                <div class="project-item" data-project-id="sample">
                    <div class="project-header">
                        <input type="text" class="editable-title" value="My First Project" onblur="updateProjectTitle('sample', this.value)" />
                        <button class="save-btn" onclick="updateProjectTitle('sample', this.previousElementSibling.value)">💾</button>
                        <div class="project-actions">
                            <button class="action-btn" onclick="playProject('sample')">▶ Play</button>
                            <button class="action-btn" onclick="editProject('sample')">✏️ Edit</button>
                            <button class="action-btn" onclick="duplicateProject('sample')">📋 Duplicate</button>
                            <button class="action-btn" onclick="deleteProject('sample')">🗑️ Delete</button>
                        </div>
                    </div>
                    <div class="project-meta">Created today • 3 tracks • Key: C Major</div>

                    <div class="project-sections">
                        <div class="section">
                            <h4>📝 Production Notes</h4>
                            <textarea class="notes-area" placeholder="Add production notes here..." rows="3"></textarea>
                        </div>
                        <div class="section">
                            <h4>🎵 Lyrics</h4>
                            <textarea class="lyrics-area" placeholder="Add lyrics here..." rows="4"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phrases Tab -->
        <div id="phrases-tab" class="tab-content">
            <div class="toolbar">
                <button class="new-project-btn" onclick="recordNewPhrase()">
                    🎤 Record New Phrase
                </button>
                <div class="controls">
                    <select class="control-btn" onchange="filterPhrases(this.value)">
                        <option value="all">All Phrases</option>
                        <option value="recent">Recent</option>
                        <option value="favorites">Favorites</option>
                    </select>
                    <button class="control-btn" onclick="bulkDeletePhrases()">🗑️ Bulk Delete</button>
                </div>
            </div>

            <div class="phrases-container" id="phrasesContainer">
                <div class="phrase-item" data-phrase-id="sample">
                    <div class="project-header">
                        <input type="text" class="editable-title" value="Chorus Hook Idea" onblur="updatePhraseTitle('sample', this.value)" />
                        <button class="save-btn" onclick="updatePhraseTitle('sample', this.previousElementSibling.value)">💾</button>
                        <div class="project-actions">
                            <button class="action-btn" onclick="playPhrase('sample')">▶ Play</button>
                            <button class="action-btn" onclick="sendPhraseToProject('sample')">📁 To Project</button>
                            <button class="action-btn" onclick="deletePhrase('sample')">🗑️ Delete</button>
                        </div>
                    </div>
                    <div class="project-meta">Recorded today • 0:15 duration</div>
                </div>
            </div>
        </div>

        <div class="project-workspace" id="projectWorkspace">
            <div class="workspace-header">
                <div class="workspace-title">🎼 New Project Workspace</div>
                <div class="workspace-controls">
                    <button class="control-btn" onclick="addSilence()">➕ Add Silence</button>
                    <button class="control-btn" onclick="addVoiceCue()">🎤 Add Voice Cue</button>
                    <button class="control-btn" onclick="exportProject()">💾 Export</button>
                    <button class="control-btn" onclick="closeProject()">✖ Close</button>
                </div>
            </div>

            <div class="timeline" id="timeline">
                <div class="timeline-ruler">
                    <span style="margin-right: 20px;">00:00</span>
                    <span style="margin-right: 20px;">00:30</span>
                    <span style="margin-right: 20px;">01:00</span>
                    <span>01:30</span>
                </div>
                <div class="timeline-track" id="timelineTrack" ondrop="dropAudioClip(event)" ondragover="allowDrop(event)">
                    <!-- Audio clips will be added here -->
                </div>
            </div>

            <div class="metronome-panel">
                <div class="bpm-control">
                    <span>🎵 BPM:</span>
                    <input type="number" class="bpm-input" id="bpmInput" value="120" min="60" max="200" onchange="updateBPM()">
                    <button class="metronome-btn" id="metronomeBtn" onclick="toggleMetronome()">♪</button>
                </div>

                <div>
                    <button class="control-btn" onclick="playProject()">▶ Play Project</button>
                    <button class="control-btn" onclick="pauseProject()">⏸ Pause</button>
                    <button class="control-btn" onclick="stopProject()">⏹ Stop</button>
                </div>
            </div>
        </div>
    </div>

    <div class="floating-controls">
        <button class="floating-btn" onclick="scrollToTop()" title="Scroll to top">↑</button>
    </div>

    <script>
        let selectedItems = new Set();
        let currentlyPlaying = null;
        let projectMode = false;
        let metronomeInterval = null;
        let metronomeActive = false;
        let timelineClips = [];

        // Auto-refresh inbox every 30 seconds
        setInterval(refreshInbox, 30000);

        function refreshInbox() {
            fetch('/api/inbox')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateInboxDisplay(data.items);
                    }
                })
                .catch(error => console.error('Error refreshing inbox:', error));
        }

        function updateInboxDisplay(items) {
            const grid = document.getElementById('inboxGrid');
            const currentItems = new Set([...grid.querySelectorAll('.inbox-item')].map(el => el.dataset.id));

            items.forEach(item => {
                if (!currentItems.has(String(item.id))) {
                    const element = createInboxItemElement(item);
                    grid.insertBefore(element, grid.firstChild);
                }
            });
        }

        function createInboxItemElement(item) {
            const div = document.createElement('div');
            div.className = 'inbox-item';
            div.dataset.id = item.id;
            div.dataset.type = item.content_type;
            div.dataset.url = item.s3_url || '';

            div.innerHTML = `
                <div class="item-header">
                    <div>
                        <div class="item-title">${item.title}</div>
                        <div class="item-meta">${item.sender_name} • ${item.date_folder}</div>
                    </div>
                    <div class="content-type ${item.content_type}">${item.content_type}</div>
                </div>
                ${item.content_type === 'voice' && item.s3_url ? `
                <div class="audio-controls">
                    <button class="play-btn" onclick="togglePlay('${item.id}')">
                        <span id="play-icon-${item.id}">▶</span>
                    </button>
                    <div class="waveform" id="waveform-${item.id}">
                        <div class="waveform-bars"></div>
                    </div>
                    <div class="speed-controls">
                        <button class="speed-btn" onclick="setSpeed('${item.id}', 0.5)">0.5x</button>
                        <button class="speed-btn active" onclick="setSpeed('${item.id}', 1)">1x</button>
                        <button class="speed-btn" onclick="setSpeed('${item.id}', 1.5)">1.5x</button>
                        <button class="speed-btn" onclick="setSpeed('${item.id}', 2)">2x</button>
                    </div>
                </div>
                <audio id="audio-${item.id}" preload="none" onended="onAudioEnded('${item.id}')">
                    <source src="${item.s3_url}" type="audio/mpeg">
                </audio>` : ''}
                <div class="item-content">${item.content}</div>
            `;

            return div;
        }

        function toggleProjectMode() {
            projectMode = !projectMode;
            const workspace = document.getElementById('projectWorkspace');
            const btn = document.querySelector('.new-project-btn');

            if (projectMode) {
                workspace.style.display = 'block';
                btn.innerHTML = '🎵 Back to Inbox';
                enableItemSelection();
            } else {
                workspace.style.display = 'none';
                btn.innerHTML = '✨ New Project';
                disableItemSelection();
                selectedItems.clear();
            }
        }

        function enableItemSelection() {
            document.querySelectorAll('.inbox-item').forEach(item => {
                item.addEventListener('click', toggleItemSelection);
                item.style.cursor = 'pointer';
            });
        }

        function disableItemSelection() {
            document.querySelectorAll('.inbox-item').forEach(item => {
                item.removeEventListener('click', toggleItemSelection);
                item.classList.remove('selected');
                item.style.cursor = 'default';
            });
        }

        function toggleItemSelection(event) {
            if (!projectMode) return;

            const item = event.currentTarget;
            const itemId = item.dataset.id;

            if (selectedItems.has(itemId)) {
                selectedItems.delete(itemId);
                item.classList.remove('selected');
            } else {
                selectedItems.add(itemId);
                item.classList.add('selected');
            }
        }

        function togglePlay(itemId) {
            const audio = document.getElementById(`audio-${itemId}`);
            const playIcon = document.getElementById(`play-icon-${itemId}`);
            const playBtn = playIcon.parentElement;

            if (currentlyPlaying && currentlyPlaying !== itemId) {
                // Stop currently playing audio
                const currentAudio = document.getElementById(`audio-${currentlyPlaying}`);
                const currentIcon = document.getElementById(`play-icon-${currentlyPlaying}`);
                const currentBtn = currentIcon.parentElement;

                currentAudio.pause();
                currentIcon.innerHTML = '▶';
                currentBtn.classList.remove('playing');
            }

            if (audio.paused) {
                audio.play();
                playIcon.innerHTML = '⏸';
                playBtn.classList.add('playing');
                currentlyPlaying = itemId;
                generateWaveform(itemId);
            } else {
                audio.pause();
                playIcon.innerHTML = '▶';
                playBtn.classList.remove('playing');
                currentlyPlaying = null;
            }
        }

        function setSpeed(itemId, speed) {
            const audio = document.getElementById(`audio-${itemId}`);
            audio.playbackRate = speed;

            // Update active speed button
            const container = audio.parentElement;
            container.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
            container.querySelector(`[onclick*="${speed}"]`).classList.add('active');
        }

        function onAudioEnded(itemId) {
            const playIcon = document.getElementById(`play-icon-${itemId}`);
            const playBtn = playIcon.parentElement;

            playIcon.innerHTML = '▶';
            playBtn.classList.remove('playing');
            currentlyPlaying = null;
        }

        function generateWaveform(itemId) {
            const waveformBars = document.querySelector(`#waveform-${itemId} .waveform-bars`);
            waveformBars.innerHTML = '';

            // Generate random waveform bars for visual effect
            const barCount = 50;
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'waveform-bar';
                bar.style.height = Math.random() * 40 + 10 + 'px';
                waveformBars.appendChild(bar);
            }
        }

        function updateBPM() {
            const bpm = document.getElementById('bpmInput').value;
            if (metronomeActive) {
                stopMetronome();
                startMetronome(bpm);
            }
        }

        function toggleMetronome() {
            const btn = document.getElementById('metronomeBtn');

            if (metronomeActive) {
                stopMetronome();
                btn.classList.remove('active');
                metronomeActive = false;
            } else {
                const bpm = document.getElementById('bpmInput').value;
                startMetronome(bpm);
                btn.classList.add('active');
                metronomeActive = true;
            }
        }

        function startMetronome(bpm) {
            const interval = 60000 / bpm;
            metronomeInterval = setInterval(() => {
                // Play metronome sound (using Web Audio API or simple beep)
                playMetronomeClick();
            }, interval);
        }

        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }
        }

        function playMetronomeClick() {
            // Simple audio context click
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'square';

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function addSilence() {
            const duration = prompt('Silence duration in seconds:', '2');
            if (duration) {
                addToTimeline('silence', `🔇 Silence (${duration}s)`, duration);
            }
        }

        function addVoiceCue() {
            const text = prompt('Voice cue text:', 'Chorus goes here...');
            if (text) {
                addToTimeline('cue', `🎤 ${text}`, '3');
            }
        }

        function addToTimeline(type, label, duration) {
            const clip = {
                id: Date.now(),
                type: type,
                label: label,
                duration: parseFloat(duration),
                position: timelineClips.length * 120
            };

            timelineClips.push(clip);
            renderTimelineClip(clip);
        }

        function renderTimelineClip(clip) {
            const track = document.getElementById('timelineTrack');
            const element = document.createElement('div');
            element.className = 'audio-clip';
            element.style.left = clip.position + 'px';
            element.style.width = (clip.duration * 40) + 'px';
            element.innerHTML = clip.label;
            element.draggable = true;
            element.dataset.clipId = clip.id;

            element.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', clip.id);
            });

            track.appendChild(element);
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function dropAudioClip(event) {
            event.preventDefault();
            // Handle dropping selected items into timeline
            if (selectedItems.size > 0) {
                selectedItems.forEach(itemId => {
                    const item = document.querySelector(`[data-id="${itemId}"]`);
                    if (item && item.dataset.type === 'voice') {
                        const title = item.querySelector('.item-title').textContent;
                        addToTimeline('audio', title, '30'); // Estimate 30s duration
                    }
                });
            }
        }

        function importS3Zip() {
            const zipKey = prompt('Enter S3 zip file name:', 'your-archive.zip');
            if (zipKey) {
                fetch('/import/s3-zip', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({zip_key: zipKey})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`✅ Successfully imported ${data.imported_count} audio files!`);
                        refreshInbox();
                    } else {
                        alert(`❌ Import failed: ${data.error}`);
                    }
                })
                .catch(error => {
                    alert(`❌ Import error: ${error.message}`);
                });
            }
        }

        function sortContent(sortBy) {
            const grid = document.getElementById('inboxGrid');
            const items = Array.from(grid.children);

            items.sort((a, b) => {
                switch(sortBy) {
                    case 'newest':
                        return parseInt(b.dataset.id) - parseInt(a.dataset.id);
                    case 'oldest':
                        return parseInt(a.dataset.id) - parseInt(b.dataset.id);
                    case 'name':
                        const nameA = a.querySelector('.item-title').textContent;
                        const nameB = b.querySelector('.item-title').textContent;
                        return nameA.localeCompare(nameB);
                    default:
                        return 0;
                }
            });

            items.forEach(item => grid.appendChild(item));
        }

        function closeProject() {
            showTab('inbox');
        }

        // Tab system functions
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');

            // Activate selected button
            event.target.classList.add('active');

            // Load content if needed
            if (tabName === 'projects') {
                loadProjects();
            } else if (tabName === 'phrases') {
                loadPhrases();
            }
        }

        function createNewProject() {
            const currentTab = document.querySelector('.tab-content.active').id;

            if (currentTab === 'projects-tab' || currentTab === 'inbox-tab') {
                const projectName = prompt('Enter project name:', 'New Project');
                if (projectName) {
                    fetch('/api/create-project', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            name: projectName,
                            selected_items: Array.from(selectedItems)
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showTab('projects');
                            loadProjects();
                        } else {
                            alert('Failed to create project: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error creating project: ' + error.message);
                    });
                }
            } else if (currentTab === 'phrases-tab') {
                recordNewPhrase();
            }
        }

        // Project functions
        function loadProjects() {
            fetch('/api/projects')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateProjectsDisplay(data.projects);
                    }
                })
                .catch(error => console.error('Error loading projects:', error));
        }

        function updateProjectsDisplay(projects) {
            const container = document.getElementById('projectsContainer');
            container.innerHTML = '';

            projects.forEach(project => {
                const projectHtml = `
                    <div class="project-item" data-project-id="${project.id}">
                        <div class="project-header">
                            <input type="text" class="editable-title" value="${project.name}" onblur="updateProjectTitle('${project.id}', this.value)" />
                            <button class="save-btn" onclick="updateProjectTitle('${project.id}', this.previousElementSibling.value)">💾</button>
                            <div class="project-actions">
                                <button class="action-btn" onclick="playProject('${project.id}')">▶ Play</button>
                                <button class="action-btn" onclick="editProject('${project.id}')">✏️ Edit</button>
                                <button class="action-btn" onclick="duplicateProject('${project.id}')">📋 Duplicate</button>
                                <button class="action-btn" onclick="deleteProject('${project.id}')">🗑️ Delete</button>
                            </div>
                        </div>
                        <div class="project-meta">${project.created_at} • ${project.track_count || 0} tracks</div>
                        <div class="project-sections">
                            <div class="section">
                                <h4>📝 Production Notes</h4>
                                <textarea class="notes-area" placeholder="Add production notes here..." rows="3" onblur="updateProjectNotes('${project.id}', this.value)">${project.notes || ''}</textarea>
                            </div>
                            <div class="section">
                                <h4>🎵 Lyrics</h4>
                                <textarea class="lyrics-area" placeholder="Add lyrics here..." rows="4" onblur="updateProjectLyrics('${project.id}', this.value)">${project.lyrics || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += projectHtml;
            });
        }

        function playProject(projectId) {
            fetch('/api/play-project/' + projectId, {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Handle project playback
                        alert('🎵 Playing project: ' + data.project_name);
                    } else {
                        alert('❌ Failed to play project: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('❌ Playback error: ' + error.message);
                });
        }

        function editProject(projectId) {
            // Open project in timeline editor
            showTab('inbox'); // For now, just go back to inbox
            alert('✏️ Project editor coming soon!');
        }

        function updateProjectTitle(projectId, newTitle) {
            fetch('/api/update-project-title', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    project_id: projectId,
                    title: newTitle
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Failed to update title: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error updating project title:', error);
            });
        }

        function updateProjectNotes(projectId, notes) {
            fetch('/api/update-project-notes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    project_id: projectId,
                    notes: notes
                })
            })
            .catch(error => console.error('Error updating notes:', error));
        }

        function updateProjectLyrics(projectId, lyrics) {
            fetch('/api/update-project-lyrics', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    project_id: projectId,
                    lyrics: lyrics
                })
            })
            .catch(error => console.error('Error updating lyrics:', error));
        }

        function deleteProject(projectId) {
            if (confirm('🗑️ Delete this project? This cannot be undone.')) {
                fetch('/api/delete-project/' + projectId, {method: 'DELETE'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadProjects();
                        } else {
                            alert('Failed to delete project: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error deleting project: ' + error.message);
                    });
            }
        }

        function scrollToTop() {
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        // Melodyne-style functions
        function toggleMelodyne(itemId) {
            const melodyne = document.getElementById(`melodyne-${itemId}`);
            const btn = event.target;

            if (melodyne.style.display === 'none') {
                melodyne.style.display = 'block';
                btn.innerHTML = '🎼 Hide Analysis';
                analyzeAudio(itemId);
            } else {
                melodyne.style.display = 'none';
                btn.innerHTML = '🎼 Analyze';
            }
        }

        function analyzeAudio(itemId) {
            const item = document.querySelector(`[data-id="${itemId}"]`);
            const audioUrl = item.dataset.url;

            if (!audioUrl) return;

            // Show loading state
            document.getElementById(`key-${itemId}`).innerHTML = '🎹 Key: Analyzing...';
            document.getElementById(`tempo-${itemId}`).innerHTML = '🥁 BPM: Analyzing...';

            fetch('/api/analyze-audio', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    audio_url: audioUrl,
                    analysis_type: 'full'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const results = data.analysis_results;

                    // Update key detection
                    if (results.key_detection) {
                        document.getElementById(`key-${itemId}`).innerHTML =
                            `🎹 Key: ${results.key_detection.detected_key} (${Math.round(results.key_detection.confidence * 100)}%)`;
                    }

                    // Update tempo
                    if (results.spectral_analysis) {
                        document.getElementById(`tempo-${itemId}`).innerHTML =
                            `🥁 BPM: ${Math.round(results.spectral_analysis.tempo)}`;
                    }

                    // Draw pitch visualization
                    if (results.pitch_track) {
                        drawPitchTrack(itemId, results.pitch_track);
                    }
                } else {
                    document.getElementById(`key-${itemId}`).innerHTML = '🎹 Key: Analysis failed';
                    document.getElementById(`tempo-${itemId}`).innerHTML = '🥁 BPM: Analysis failed';
                }
            })
            .catch(error => {
                console.error('Analysis error:', error);
                document.getElementById(`key-${itemId}`).innerHTML = '🎹 Key: Error';
                document.getElementById(`tempo-${itemId}`).innerHTML = '🥁 BPM: Error';
            });
        }

        function drawPitchTrack(itemId, pitchTrack) {
            const container = document.getElementById(`pitch-track-${itemId}`);
            container.innerHTML = '<canvas class="pitch-visualization" id="pitch-canvas-' + itemId + '"></canvas>';

            const canvas = document.getElementById(`pitch-canvas-${itemId}`);
            const ctx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            if (pitchTrack.length === 0) return;

            // Find pitch range
            const freqs = pitchTrack.map(p => p.frequency).filter(f => f > 0);
            if (freqs.length === 0) return;

            const minFreq = Math.min(...freqs);
            const maxFreq = Math.max(...freqs);
            const freqRange = maxFreq - minFreq;

            // Draw pitch curve
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
            ctx.lineWidth = 2;
            ctx.beginPath();

            pitchTrack.forEach((point, index) => {
                if (point.frequency > 0) {
                    const x = (point.time / pitchTrack[pitchTrack.length - 1].time) * canvas.width;
                    const y = canvas.height - ((point.frequency - minFreq) / freqRange) * canvas.height;

                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
            });

            ctx.stroke();

            // Draw note names at key points
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
            ctx.font = '10px Inter, sans-serif';
            ctx.textAlign = 'center';

            for (let i = 0; i < pitchTrack.length; i += Math.floor(pitchTrack.length / 10)) {
                const point = pitchTrack[i];
                if (point.frequency > 0) {
                    const x = (point.time / pitchTrack[pitchTrack.length - 1].time) * canvas.width;
                    const y = canvas.height - ((point.frequency - minFreq) / freqRange) * canvas.height;
                    ctx.fillText(point.note_name, x, Math.max(y - 5, 15));
                }
            }
        }

        function previewTranspose(itemId, semitones) {
            document.getElementById(`transpose-value-${itemId}`).innerHTML =
                semitones > 0 ? `+${semitones}` : semitones;
        }

        function applyTranspose(itemId) {
            const item = document.querySelector(`[data-id="${itemId}"]`);
            const audioUrl = item.dataset.url;
            const semitones = document.getElementById(`transpose-${itemId}`).value;

            if (!audioUrl || semitones == 0) return;

            if (!confirm(`Transpose by ${semitones > 0 ? '+' : ''}${semitones} semitones? This will create a new version.`)) {
                return;
            }

            const btn = event.target;
            btn.innerHTML = 'Processing...';
            btn.disabled = true;

            fetch('/api/transpose-audio', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    audio_url: audioUrl,
                    semitones: parseFloat(semitones)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✅ Transposed version created! Refreshing inbox...`);
                    refreshInbox();
                } else {
                    alert(`❌ Transpose failed: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`❌ Transpose error: ${error.message}`);
            })
            .finally(() => {
                btn.innerHTML = 'Apply';
                btn.disabled = false;
            });
        }

        // Phrases functions
        function loadPhrases() {
            fetch('/api/phrases')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updatePhrasesDisplay(data.phrases);
                    }
                })
                .catch(error => console.error('Error loading phrases:', error));
        }

        function updatePhrasesDisplay(phrases) {
            const container = document.getElementById('phrasesContainer');
            container.innerHTML = '';

            phrases.forEach(phrase => {
                const phraseHtml = `
                    <div class="phrase-item" data-phrase-id="${phrase.id}">
                        <div class="project-header">
                            <input type="text" class="editable-title" value="${phrase.title}" onblur="updatePhraseTitle('${phrase.id}', this.value)" />
                            <button class="save-btn" onclick="updatePhraseTitle('${phrase.id}', this.previousElementSibling.value)">💾</button>
                            <div class="project-actions">
                                <button class="action-btn" onclick="playPhrase('${phrase.id}')">▶ Play</button>
                                <button class="action-btn" onclick="sendPhraseToProject('${phrase.id}')">📁 To Project</button>
                                <button class="action-btn" onclick="deletePhrase('${phrase.id}')">🗑️ Delete</button>
                            </div>
                        </div>
                        <div class="project-meta">${phrase.created_at} • ${phrase.duration || '0:15'} duration</div>
                    </div>
                `;
                container.innerHTML += phraseHtml;
            });
        }

        function recordNewPhrase() {
            alert('🎤 Voice phrase recording coming soon! For now, use the phone system.');
        }

        function updatePhraseTitle(phraseId, newTitle) {
            fetch('/api/update-phrase-title', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    phrase_id: phraseId,
                    title: newTitle
                })
            })
            .catch(error => console.error('Error updating phrase title:', error));
        }

        function playPhrase(phraseId) {
            fetch('/api/play-phrase/' + phraseId, {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('🎵 Playing phrase: ' + data.phrase_title);
                    } else {
                        alert('❌ Failed to play phrase: ' + data.error);
                    }
                })
                .catch(error => alert('❌ Playback error: ' + error.message));
        }

        function sendPhraseToProject(phraseId) {
            const projectName = prompt('Enter project name:', 'New Project from Phrase');
            if (projectName) {
                fetch('/api/phrase-to-project', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        phrase_id: phraseId,
                        project_name: projectName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showTab('projects');
                        loadProjects();
                    } else {
                        alert('Failed to create project: ' + data.error);
                    }
                })
                .catch(error => alert('Error: ' + error.message));
            }
        }

        function deletePhrase(phraseId) {
            if (confirm('🗑️ Delete this phrase? This cannot be undone.')) {
                fetch('/api/delete-phrase/' + phraseId, {method: 'DELETE'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadPhrases();
                        } else {
                            alert('Failed to delete phrase: ' + data.error);
                        }
                    })
                    .catch(error => alert('Error deleting phrase: ' + error.message));
            }
        }

        // Inbox item functions
        function updateTitle(itemId, newTitle) {
            fetch('/api/update-title', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    item_id: itemId,
                    title: newTitle
                })
            })
            .catch(error => console.error('Error updating title:', error));
        }

        function sendToProject(itemId) {
            const projectName = prompt('Enter project name:', 'New Project');
            if (projectName) {
                fetch('/api/send-to-project', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        item_id: itemId,
                        project_name: projectName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('✅ Added to project: ' + projectName);
                        showTab('projects');
                        loadProjects();
                    } else {
                        alert('❌ Failed to add to project: ' + data.error);
                    }
                })
                .catch(error => alert('❌ Error: ' + error.message));
            }
        }

        function sendToPhrases(itemId) {
            fetch('/api/send-to-phrases', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    item_id: itemId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ Added to phrases!');
                    showTab('phrases');
                    loadPhrases();
                } else {
                    alert('❌ Failed to add to phrases: ' + data.error);
                }
            })
            .catch(error => alert('❌ Error: ' + error.message));
        }

        function deleteItem(itemId) {
            if (confirm('🗑️ Delete this item? This cannot be undone.')) {
                fetch('/api/delete-item/' + itemId, {method: 'DELETE'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.querySelector(`[data-id="${itemId}"]`).remove();
                        } else {
                            alert('❌ Failed to delete: ' + data.error);
                        }
                    })
                    .catch(error => alert('❌ Error: ' + error.message));
            }
        }

        function bulkDelete() {
            if (selectedItems.size === 0) {
                alert('❌ No items selected for bulk delete');
                return;
            }

            if (confirm(`🗑️ Delete ${selectedItems.size} selected items? This cannot be undone.`)) {
                fetch('/api/bulk-delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        item_ids: Array.from(selectedItems)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        selectedItems.forEach(id => {
                            const element = document.querySelector(`[data-id="${id}"]`);
                            if (element) element.remove();
                        });
                        selectedItems.clear();
                        alert(`✅ Deleted ${data.deleted_count} items`);
                    } else {
                        alert('❌ Bulk delete failed: ' + data.error);
                    }
                })
                .catch(error => alert('❌ Error: ' + error.message));
            }
        }

        // Initialize waveforms for all audio items on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.inbox-item[data-type="voice"]').forEach(item => {
                generateWaveform(item.dataset.id);
            });

            // Enable item selection by default for inbox
            enableItemSelection();

            // Load initial data for all tabs
            loadProjects();
            loadPhrases();
        });
    </script>
</body>
</html>